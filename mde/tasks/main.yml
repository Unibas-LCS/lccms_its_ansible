---
- block:
  - name: |
      We are required to have the Microsoft Defender installed and running.</br>
      Create MDATP directory (/etc/opt/microsoft/mdatp/managed), if necessary.
    file:
      path: /etc/opt/microsoft/mdatp/managed
      state: directory
      mode: 0755
      owner: root
      group: root

  - name: "Copying Onboarding Configuration from the template."
    template:
      src: mdatp_onboard.json.j2
      dest: /etc/opt/microsoft/mdatp/mdatp_onboard.json
      mode: 0600
      owner: root
      group: root

  - name: "Creating Managed Configuration from the default file."
    template:
      src: mdatp_managed.json.j2
      dest: /etc/opt/microsoft/mdatp/managed/mdatp_managed.json
      mode: 0600
      owner: root
      group: root
    when: its_mde.alternative_file is not defined

  - name: "Creating Managed Configuration from the given file {{ its_mde.alternative_file }}."
    template:
      src: "{{ its_mde.alternative_file }}"
      dest: /etc/opt/microsoft/mdatp/managed/mdatp_managed.json
      mode: 0600
      owner: root
      group: root
    when: its_mde.alternative_file is defined

  - name: "Download Microsoft GPG key."
    ansible.builtin.get_url:
      url: https://packages.microsoft.com/keys/microsoft.asc
      dest: /usr/share/keyrings/microsoft.asc
      mode: '0644'

  - name: "Convert Microsoft GPG key to dearmored format."
    ansible.builtin.command:
      cmd: gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg /usr/share/keyrings/microsoft.asc
      creates: /usr/share/keyrings/microsoft-prod.gpg

  - name: "Add Microsoft Defender APT repository (Deb822 format)."
    ansible.builtin.deb822_repository:
      name: microsoft-prod
      types: [deb]
      uris: https://packages.microsoft.com/ubuntu/24.04/prod
      suites: [noble]
      components: [main]
      signed_by: /usr/share/keyrings/microsoft-prod.gpg
      architectures: amd64
    register: ms_repo

  - name: "Update apt cache if repository changed."
    ansible.builtin.apt:
      update_cache: yes
    when: ms_repo.changed

  - name: "Install Microsoft Defender."
    ansible.builtin.apt:
      name: mdatp
      state: present

  - name: |
      Install weekly defender quick scan cronjob if not set up.</br>
      Any output should go to the file /var/log/mdatp_cron_job.log
    cron:
      name: "Weekly quick scan defender"
      minute: "0"
      hour: "2"
      weekday: "sat"
      user: root
      job: "/bin/mdatp scan quick >> /var/log/mdatp_cron_job.log"

  - name: "Install the mdatp_cron_job logrotate file."
    copy:
      src: "mdatp_cron_job"
      dest: "/etc/logrotate.d/mdatp_cron_job"
  when: global_network_available | default(false)
  tags: self-managed
